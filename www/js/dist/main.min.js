angular.module("kumpanium").config(["$modalProvider",function(e){angular.extend(e.defaults,{html:!0,animation:"am-fade-and-scale",placement:"top"})}]).config(["$popoverProvider",function(e){angular.extend(e.defaults,{placement:"top",animation:"am-fade-and-scale"})}]).config(["$timepickerProvider",function(e){angular.extend(e.defaults,{timeFormat:"HH:mm",timeType:"number"})}]).config(["$datepickerProvider",function(e){angular.extend(e.defaults,{dateFormat:"dd.MM.yyyy",startWeek:1})}]).config(["paginationTemplateProvider",function(e){e.setPath("html/dirpagination.html")}]),angular.module("kumpaniumDirectives").directive("cacheTemplate",["$templateCache",function(e){return{restrict:"A",priority:100,terminal:!0,link:function(t,n,r){var i=r.cacheTemplate,a=e.get(i);a&&a===n[0].innerHTML||e.put(i,n[0].innerHTML),n.remove()}}}]).directive("compile",["$compile",function(e){return{restrict:"A",link:function(t,n,r){var i=t.$watch(function(e){return e.$eval(r.compile)},function(r){n.html(r),e(n.contents())(t),i()})}}}]).directive("showErrors",function(){return{restrict:"A",require:"form",link:function(e,t,n,r){function i(e){s[e].toggleClass("has-error",r[e].$invalid)}var a=t[0].getElementsByClassName("form-group"),o=a.length,s={};if(0!==o){for(;o--;){var u=a[o].querySelector("[name]");if(u){var l=angular.element(u);s[l.attr("name")]=angular.element(a[o]),l.bind("change",function(){i(this.getAttribute("name"))})}}e.$on("show-errors-check-validity",function(e,t){for(var n in t)t.hasOwnProperty(n)&&s.hasOwnProperty(n)&&i(n)})}}}}).directive("validPhone",function(){return{require:"ngModel",link:function(e,t,n,r){r.$validators.phone=function(e){if(r.$isEmpty(e))return!0;if(isNaN(e))return!1;var t=e.replace(/(^00)|\D/g,"").length;return t>12||9>t?!1:!0}}}}).directive("usernameExists",function(){return{require:"ngModel",link:function(e,t,n,r){var i=["Jim","John","Jill","Jackie"];r.$asyncValidators.username=function(e){if(r.$isEmpty(e))return $q.when();var t=$q.defer();return $timeout(function(){-1===i.indexOf(e)?t.resolve():t.reject()},2e3),t.promise}}}}),angular.module("kumpaniumFilters").filter("label",function(){return function(e,t){return'<span class="label label-'+(t||"default")+'">'+e+"</span>"}}).filter("liters",["$filter",function(e){return function(t,n){var r=t/1e3;return(n?e("number")(r,n):~~r)+" L"}}]).filter("percent",function(){return function(e){return~~(100*e)+"%"}}).filter("total",["Utils",function(e){return function(t){var n=t instanceof Array?t.length:0,r=arguments.length;if(1===r||0===n)return n;for(var i=[];r-->1;){var a=arguments[r].split("."),o=e.getNestedPropertyByKey(t[0],a);if(isNaN(o))throw'filter "total" is able count only numeric values';i.push(a)}for(var s=0;n--;){for(var u=1,l=0;l<i.length;l++)u*=e.getNestedPropertyByKey(t[n],i[l]);s+=u}return s}}]).filter("max",["$filter",function(e){return function(t,n){var r=e("orderBy")(t,n,!0);return r[0][n]}}]).filter("min",["$filter",function(e){return function(t,n){var r=e("orderBy")(t,n);return r[0][n]}}]).filter("groupBy",["Utils",function(e){if("undefined"==typeof t)var t={};return function(n,r,i){if(!(n instanceof Array&&0!==n.length&&r))return n;var a=angular.toJson(n[0]).substr(0,25)+n.length+r;if("undefined"==typeof t[a]){for(var o,s={},u=n.length;u--;){switch(o=e.getNestedPropertyByKey(n[u],r),i){case"date":o=o.substr(0,10)}"undefined"==typeof s[o]&&(s[o]=[]),s[o].push(n[u])}t[a]=s}return t[a]}}]).filter("beerTranslate",function(){return function(e){return"string"==typeof e?e.replace(/piv|mal/gi,function(e){return"*"+("mal"===e?300:500)+"+"}):void 0}}).filter("calculate",function(){return function(input){if(!isNaN(+input))return+input;if("string"==typeof input){var simpleMath=input.replace(/(,\d+)|(?:[^\s\d\+\-\*\/])/g,function(e,t){return t?t.replace(",","."):""});return simpleMath=simpleMath.replace(/(?:[\s\+\-\*\/]*$)|(?:^[\s\+\-\*\/]*)/g,""),eval(simpleMath)}}}).filter("capitalize",function(){return function(e){return e.charAt(0).toUpperCase()+e.slice(1)}}).filter("charcount",function(){return function(e){return"undefined"!=typeof e&&(e=e.replace(/(<[^>]+?>)/gi,"").replace(/(\&.+?\;)/g," ")),e&&e.length||0}}).filter("wordcount",function(){return function(e){return"undefined"!=typeof e&&(e=e.replace(/(<[^>]*?>)/gi," ").match(/\S+/g)),e&&e.length||0}}),angular.module("kumpanium").config(["$routeProvider",function(e){"use strict";var t="/partials";e.when("/novinky",{title:"Novinky",templateUrl:t+"/news",controller:"NewsController"}).when("/konzumenti",{title:"Konzumenti",templateUrl:t+"/users",controller:"UsersController"}).when("/statistiky",{title:"Statistiky",templateUrl:t+"/stats",controller:"StatsController"}).when("/zasoby",{title:"Zásoby",templateUrl:t+"/stock",controller:"StockController"}).otherwise({redirectTo:"/novinky"})}]).run(["$rootScope",function(e){e.$on("$routeChangeSuccess",function(e,t){document.title=t.title+" | Kumpanium"})}]),angular.module("kumpaniumControllers").controller("NewsController",["$scope","API","$q","$rootScope",function(e,t,n,r){"use strict";function i(e){var t=r.usersById[e.user];e.user={id:t.id,name:t.name,context:t.getRole().context}}var a=t("news");e.activeTab=1,n.all([a.query().$promise,r.users.$promise]).then(function(t){for(var n=t[0],r=n.length;r--;)i(n[r]);e.news=n}),e.newsAdd={init:function(){this.news=new a,this.original=this.index={}},save:function(){var t=this.news,n=this.original;if(this.form.$setSubmitted(),!this.form.$invalid){if(t.setTerm&&t.dateEnd){if(t.timeEnd){var r=t.timeEnd/1e3/60;t.dateEnd.setUTCHours(~~(r/60)),t.dateEnd.setUTCMinutes(r%60)}}else t.dateEnd=null;delete t.setTerm,t.$save(function(){i(t),n?(angular.copy(t,n),e.activeTab=this.index):(e.news.push(t),e.activeTab=1),e.newsAdd.init(),e.newsAdd.form.$setPristine()},function(){})}},load:function(t,n){if(this.index=n+1,this.original=t,this.news=angular.copy(t),t.dateEnd){this.news.setTerm=!0;var r=new Date(t.dateEnd);this.news.dateEnd=r,this.news.timeEnd=e.isFullDay(r)?null:r.getTime()%864e5}e.activeTab=0}},e.newsAdd.init(),e.isFullDay=function(e){return/00:00:00/.test(e)}}]),angular.module("kumpaniumControllers").run(["$rootScope","$window","User",function(e,t,n){"use strict";e.isManager=t.isManager,e.currentUser=t.currentUser,e.usersById={},e.users=n.query(function(t){for(var n=t.length;n--;)e.usersById[t[n].id]=t[n]})}]),angular.module("kumpaniumControllers").controller("StatsController",["$scope","$http","Utils",function(e,t,n){"use strict";var r=["Bar","Doughnut","Line","Pie","PolarArea","Radar"];e.chart={labels:[],data:[],series:[],type:r[0],clear:function(){this.labels=[],this.series=[],this.data=[]}},e.chartControl={chart:{},form:{},type:[{value:"Bar",label:"stav"},{value:"Line",label:"vývoj"},{value:"Pie",label:"podíl"}],series:[{value:"user",label:"lidí"},{value:"beer",label:"piva"}],data:[{value:"consumption",label:"výtoč [L]"},{value:"credit",label:"útratu [Kč]"}],response:{},load:function(){var e=this,r=this.chart,i="/futro/stat?data="+r.data+"&series="+r.series;r.dateBegin&&(i+="&dateBegin="+n.dateToISO(r.dateBegin)),r.dateEnd&&(i+="&dateEnd="+n.dateToISO(r.dateEnd)),t.get(i).success(function(t){e.response=t,e.plot()}).error(function(){})},plot:function(){var t=e.chart,n=this.response.length;if(0!==n){t.clear();var r,i=t.data,a={};switch(t.type=this.chart.type){case"Bar":t.data.push([]),i=t.data[0];case"Pie":for(var o=0;n>o;o++)r=this.response[o],"undefined"==typeof a[r.series]&&(a[r.series]=0),a[r.series]+=r.data;for(var s in a)t.labels.push(s),i.push(a[s]);for(var o=0,u=i.length;u>o;o++)i[o]=+i[o].toFixed(2);break;case"Line":for(var l,c={},o=0;n>o;o++)r=this.response[o],"undefined"==typeof a[r.date]&&(a[r.date]={}),a[r.date][r.series]=r.data,c[r.series]=!0;for(var d in c)t.series.push(d);for(var f in a){t.labels.push(f);for(var o=0,u=t.series.length;u>o;o++)d=t.series[o],"undefined"==typeof i[o]&&i.push([]),l=i[o][i[o].length-1]||0,i[o].push(+(l+(a[f][d]||0)).toFixed(2))}}}},init:function(){var e=new Date;e.setMonth(0),e.setDate(1),e.setHours(0),e.setMinutes(0),this.chart={type:"Bar",series:"user",data:"consumption",dateBegin:e},this.load()}},e.chartControl.init()}]),angular.module("kumpaniumControllers").controller("StockController",["$scope","API","Utils","Keg","$modal",function(e,t,n,r,i){"use strict";var a=t("brewery"),o=t("beer");r.query(function(t){e.kegs=t}),a.query(function(t){e.breweries=t}),e.finished={itemsPerPage:9,getPage:function(e){var t=this,n=this.itemsPerPage+","+(~~e-1)*this.itemsPerPage;r.query({state:r.prototype.states[2],limit:n},function(e){t.kegs=e,t.count=e.length>0?e[0].metadata.count:0})},loss:{good:.06,warn:.1,critic:.13}},e.finished.getPage(1),e.kegAdd={init:function(){this.keg=new r,this.keg.quantity=1,this.beers=null},save:function(){if(this.form.$setSubmitted(),!this.form.$invalid){var t=this.keg.quantity;this.keg.dateAdd=this.keg.currentDateTime(),this.keg.$save(function(r){var i="Skladové zásoby obohaceny o "+t+"x "+r.volume/1e3+" L "+r.beer.brewery.name+" "+r.beer.name;for(n.alertMessage("Dobrý!",i,"success","#new_stock_alert_container");t--;){var a=angular.copy(r);a.id-=t,e.kegs.push(a)}e.kegAdd.init()},function(e){var t="Něco se pokazilo: <br /><br /><pre><strong>"+e.data.status+" "+e.data.code+":</strong><br />"+e.data.message+"</pre>";n.alertMessage("Špatný!",t,"danger","#new_stock_alert_container")})}},eventBrewerySelected:function(){this.beers=a.query({id:this.keg.brewery,relation:"beer"})},eventBeerSelected:function(){var t=this;"undefined"==typeof this.keg.price&&-1!==this.keg.volumes.indexOf(this.keg.volume)&&e.kegs.$promise.then(function(e){for(var n,r=e.length;r--;)if(t.keg.beer===e[r].beer.id){if(t.keg.volume===e[r].volume)return t.keg.price=e[r].price;"undefined"==typeof n&&(n=e[r].price/e[r].volume)}"undefined"!=typeof n&&(t.keg.price=~~(n*t.keg.volume))})}},e.kegAdd.init(),e.beerAdd=i({scope:e,template:"modals/beeradd",show:!1}),angular.extend(e.beerAdd,{init:function(){this.beer=new o,this.beer.brewery=e.kegAdd.keg.brewery},save:function(){this.form.$setSubmitted(),this.form.$invalid||this.beer.$save(function(t){e.kegAdd.beers.push(t),e.kegAdd.keg.beer=t.id,e.beerAdd.hide()},function(){})}}),e.breweryAdd=i({scope:e,template:"modals/breweryadd",show:!1}),angular.extend(e.breweryAdd,{init:function(){this.brewery=new a},save:function(){this.form.$setSubmitted(),this.form.$invalid||this.brewery.$save(function(t){e.breweries.push(t),e.kegAdd.keg.brewery=t.id,e.kegAdd.eventBrewerySelected(),e.breweryAdd.hide(),e.beerAdd.show()},function(){})}})}]),angular.module("kumpaniumControllers").controller("UsersController",["$scope","API",function(e,t){"use strict";e.userEdit={user:{},model:{},edit:{},password:{},init:function(e){this.user=e,this.model={name:e.name,email:e.email,phone:e.phone},this.edit=this.password={}},save:function(){var e=!1;for(var t in this.model)this.model.hasOwnProperty(t)&&this.edit[t]&&this.model[t]&&this.user[t]!==this.model[t]&&(e=this.user[t]=this.model[t]);return this.password.new1&&(e=this.user.password=this.password),e!==!1?(this.user.$save(),!0):!1}},e.creditAdd={init:function(e){var n=new t("user",e.id,"credit");this.user=e,this.credit=new n},save:function(){return this.form.$setSubmitted(),this.form.$invalid?void 0:(this.credit.dateAdd=this.credit.currentDateTime(),this.credit.$save(function(t){return e.creditAdd.user.credit.push(t),e.creditAdd.user.balance+=t.amount,!0},function(){return!1}))}}}]),angular.module("kumpaniumServices").factory("API",["$resource","Utils",function(e,t){"use strict";var n="/futro/";return function(r,i,a){var o=n+(r||":presenter")+"/"+(i||":id")+"/"+(a||":relation")+"/:relationId",s=e(o,{id:"@id"},{update:{method:"PUT"},get:{method:"GET",cache:!0,params:{outputAssoc:1}},query:{method:"GET",cache:!0,isArray:!0}});return s.prototype.currentDateTime=function(){return t.dateToISO()},s.prototype.confirmDelete=function(e,t,n){e=e||"Opravdu smazat položku ID: "+this.id,confirm(e)&&this.$delete(t,n)},s}}]),angular.module("kumpaniumServices").factory("Keg",["API","$filter","$q",function(e,t,n){"use strict";var r=e("keg");return angular.extend(r.prototype,{states:["STOCKED","TAPPED","FINISHED"],stateLabels:[{text:"Skladem",context:"success"},{text:"Na čepu",context:"warning"},{text:"Vypito",context:"default"}],volumes:[5e3,1e4,15e3,2e4,25e3,3e4,5e4],getConsumption:function(){var e=this;this.consumption=r.query({id:this.id,relation:"consumption"},function(){e.rest=e.volume-t("total")(e.consumption,"volume")})},saveConsumption:function(n){var i=this.consumption,a={volume:t("calculate")(t("beerTranslate")(n.volume)),user:n.user,keg:this.id,dateAdd:r.currentDateTime()};return e("consumption").save(a,function(e){i.push(e)})},removeConsumptions:function(){for(var t=this.consumption,r=e("consumption"),i=t.length,a=[],o={};i--;)if(t[i].checked){var s=t[i].id;o[s]=i,a.push(r["delete"]({id:s}).$promise)}n.all(a).then(function(e){for(var n=0;n<e.length;n++)t.splice(o[e[n].id],1)})},getStateLabel:function(e){function t(e){return'<span class="label label-'+(e.context||"default")+'">'+e.text+"</span>"}if(e=e||this.state,"remove"===e)return t({text:"Smazat",context:"danger"});var n=this.states.indexOf(e);return-1!==n?t(this.stateLabels[n]):void 0}}),r}]),angular.module("kumpaniumServices").factory("User",["API",function(e){"use strict";var t=4,n=e("user"),r={super_admin:{name:"Administrátor",context:"primary"},beer_manager:{name:"Pivní manager",context:"success"},kumpan:{name:"Kumpán",context:"danger"},guest:{name:"Spřízněná duše",context:"default"}};return angular.extend(n.prototype,{getRole:function(){var e={name:'<i class="glyphicon glyphicon-star"></i> Mecenáš <i class="glyphicon glyphicon-star"></i>',context:"warning"};return this.id===t?e:r[this.role]},getRoleLabel:function(){var e=this.getRole();return'<span class="label label-'+e.context+'">'+e.name+"</span>"},consumptionPerPage:15,getConsumption:function(e){e=e||1;var t=this.consumptionPerPage+","+(~~e-1)*this.consumptionPerPage;this.consumption=n.query({id:this.id,relation:"consumption",limit:t})},creditPerPage:20,getCredit:function(e){e=e||1;var t=this.creditPerPage+","+(~~e-1)*this.creditPerPage;this.credit=n.query({id:this.id,relation:"credit",limit:t})}}),n}]),angular.module("kumpaniumServices").service("Utils",["$alert",function(e){"use strict";return{getNestedPropertyByKey:function(e,t){t instanceof Array||(t=t.split("."));for(var n=0;n<t.length;n++)e=e[t[n]];return e},alertMessage:function(t,n,r,i){var a={title:t,content:n,type:r||"info",container:i};e(a)},validateForm:function(e,t){e.$broadcast("show-errors-check-validity",t)},dateToISO:function(e){return e instanceof Date||(e=new Date(e||null)),Date.prototype.toISOString||!function(){function e(e){return 10>e?"0"+e:e}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+e(this.getUTCMonth()+1)+"-"+e(this.getUTCDate())+"T"+e(this.getUTCHours())+":"+e(this.getUTCMinutes())+":"+e(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}}(),e.toISOString()}}}]);